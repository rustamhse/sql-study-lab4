# Лабораторная работа 4
###### Хранимые процедуры
## Задание 1
Реализовать хранимую процедуру, возвращающую текстовую строку, содержащую информацию о водителе(идентификатор, фамилия, дата, место и товар последней перевозки). Обработать ситуацию, когда водитель еще не использовался.

```
CREATE OR REPLACE FUNCTION last_shipment (int)
RETURNS table(ВОДИТЕЛЬ int, ФАМИЛИЯ varchar(50), ДАТА varchar(10), "МЕСТО (?)" varchar(50), ТОВАР text) AS
$$ 
BEGIN
  return query SELECT ЗАКАЗ.ВОДИТЕЛЬ, ВОДИТЕЛЬ.ФАМИЛИЯ, КАЛЕНДАРЬ.МЕСЯЦ, "ЦЕНТР ОБСЛУЖИВАНИЯ".НАЗВАНИЕ "МЕСТО (?)", ПРЕЙСКУРАНТ.ТОВАР
  FROM ЗАКАЗ
  JOIN КАЛЕНДАРЬ ON ЗАКАЗ.ДАТА = КАЛЕНДАРЬ.МЕСЯЦ
  JOIN ВОДИТЕЛЬ ON ВОДИТЕЛЬ.ИДЕНТИФИКАТОР = ЗАКАЗ.ВОДИТЕЛЬ
  JOIN "ЦЕНТР ОБСЛУЖИВАНИЯ" ON "ЦЕНТР ОБСЛУЖИВАНИЯ".ВЛАДЕЛЕЦ = ВОДИТЕЛЬ.АВТОПРЕДПРИЯТИЕ
  JOIN ПРЕЙСКУРАНТ ON ЗАКАЗ."ТОВАР ПО ПРЕЙСКУРАНТУ" = ПРЕЙСКУРАНТ.ИДЕНТИФИКАТОР
  WHERE ЗАКАЗ.ВОДИТЕЛЬ = $1
  ORDER BY КАЛЕНДАРЬ."ПОРЯДКОВЫЙ НОМЕР" DESC
  LIMIT 1;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Водитель с идентификатором % не найден!', $1;
  END IF;
  
  return;
END
$$ LANGUAGE plpgsql;
```

ВСЕ ЗАКАЗЫ ВОДИТЕЛЯ С ИДЕНТИФИКАТОРОМ 1 (ДЛЯ ПРОВЕРКИ) 

| ВОДИТЕЛЬ | ФАМИЛИЯ | ДАТА | МЕСТО (?) | ТОВАР |
|-----------------:|:---------------|:---------|:---------------|:-----------|
| 1 | Горбунов | Май | Окружная дорога1 | Прокладка |
| 1 | Горбунов | Май | Окружная дорога2 | Прокладка |
| 1 | Горбунов | Май | АЗС7 | Прокладка |
| 1 | Горбунов | Сентябрь | Окружная дорога1 | Свеча зажигания |
| 1 | Горбунов | Сентябрь | Окружная дорога2 | Свеча зажигания |
| 1 | Горбунов | Сентябрь | АЗС7 | Свеча зажигания |

ВЫЗОВ ФУНКЦИИ ДЛЯ ВОДИТЕЛЯ С ИДЕНТИФИКАТОРОМ 1

```
SELECT * FROM last_shipment(1);
```

| ВОДИТЕЛЬ | ФАМИЛИЯ | ДАТА | МЕСТО (?) | ТОВАР |
|-----------------:|:---------------|:---------|:---------------|:-----------|
| 1 | Горбунов | Сентябрь | Окружная дорога1 | Свеча зажигания |

ОТРАБОТКА ОШИБОЧНОГО СЦЕНАРИЯ

```
SELECT * FROM last_shipment(99999);
```

> ``` error
> ERROR:  Водитель с идентификатором 99999 не найден!
> CONTEXT:  PL/pgSQL function last_shipment(integer) line 14 at RAISE
> ```


## Задание 2
Добавить таблицу, содержащую списки допустимых водителей по каждому автопредприятию. При вводе заказа проверять водителя.

```
CREATE TABLE "ДОСТУПНЫЕ ВОДИТЕЛИ"(
	ИДЕНТИФИКАТОР int CHECK (ИДЕНТИФИКАТОР > 0),
	ФАМИЛИЯ varchar (50),
	"ИДЕНТИФИКАТОР АВТОПРЕДПРИЯТИЯ" int CHECK ("ИДЕНТИФИКАТОР АВТОПРЕДПРИЯТИЯ" > 0),
	АВТОПРЕДПРИЯТИЕ varchar (50));

INSERT INTO "ДОСТУПНЫЕ ВОДИТЕЛИ"
SELECT ВОДИТЕЛЬ.ИДЕНТИФИКАТОР, ВОДИТЕЛЬ.ФАМИЛИЯ, "ЦЕНТР ОБСЛУЖИВАНИЯ".ИДЕНТИФИКАТОР, "ЦЕНТР ОБСЛУЖИВАНИЯ".НАЗВАНИЕ
FROM ВОДИТЕЛЬ
JOIN "ЦЕНТР ОБСЛУЖИВАНИЯ" ON "ЦЕНТР ОБСЛУЖИВАНИЯ".ВЛАДЕЛЕЦ = ВОДИТЕЛЬ.АВТОПРЕДПРИЯТИЕ;

SELECT * FROM "ДОСТУПНЫЕ ВОДИТЕЛИ";
```

| ИДЕНТИФИКАТОР | ФАМИЛИЯ | ИДЕНТИФИКАТОР АВТОПРЕДПРИЯТИЯ | АВТОПРЕДПРИЯТИЕ |
|---------------------------:|:---------------|----------------------------------------------------------:|:-------------------------------|
| 1 | Горбунов | 5 | АЗС7 |
| 1 | Горбунов | 2 | Окружная дорога2 |
| 1 | Горбунов | 1 | Окружная дорога1 |
| 3 | Денисов | 3 | 123КМ |
| 4 | Сергеев | 3 | 123КМ |
| 5 | Левкин | 5 | АЗС7 |
| 5 | Левкин | 2 | Окружная дорога2 |
| 5 | Левкин | 1 | Окружная дорога1 |

``` 
CREATE OR REPLACE FUNCTION checkAvailability()
RETURNS TRIGGER
AS 
$$
BEGIN
	PERFORM * FROM "ДОСТУПНЫЕ ВОДИТЕЛИ" 
	WHERE "ДОСТУПНЫЕ ВОДИТЕЛИ".ИДЕНТИФИКАТОР = NEW.ВОДИТЕЛЬ AND "ДОСТУПНЫЕ ВОДИТЕЛИ"."ИДЕНТИФИКАТОР АВТОПРЕДПРИЯТИЯ" = NEW."ЦЕНТР ОБСЛ.";
	IF NOT FOUND THEN
		RAISE EXCEPTION 'Указан неверный ИДЕНТИФИКАТОР ВОДИТЕЛЯ и/или ИДЕНТИФИКАТОР ПРЕДПРИЯТИЯ';
	END IF;
	RETURN NEW;
END
$$
LANGUAGE PLPGSQL;

CREATE OR REPLACE TRIGGER triggerCheckAvailability
BEFORE INSERT ON ЗАКАЗ
FOR EACH ROW EXECUTE FUNCTION checkAvailability();
```

ПРОВЕРКА ОШИБОЧНОГО СЦЕНАРИЯ

``` 
INSERT INTO "ЗАКАЗ" VALUES
(88888, 'Декабрь', 2, 4*, 7, 4, 48000);
* указано несуществующее предприятие

SELECT * FROM ЗАКАЗ
```
> ``` error
> ERROR:  Указан неверный ИДЕНТИФИКАТОР ВОДИТЕЛЯ и/или ИДЕНТИФИКАТОР ПРЕДПРИЯТИЯ
> CONTEXT:  PL/pgSQL function checkavailability() line 6 at RAISE
> ```

ПРОВЕРКА ВЕРНОГО СЦЕНАРИЯ

``` 
INSERT INTO "ЗАКАЗ" VALUES
(88888, 'Декабрь', 1, 5, 7, 4, 48000);

SELECT * FROM ЗАКАЗ
```

| НОМЕР ВЕДОМОСТИ | ДАТА | ВОДИТЕЛЬ | ЦЕНТР ОБСЛ. | ТОВАР ПО ПРЕЙСКУРАНТУ | КОЛ-ВО | ИТОГО |
|------------------------------:|:---------|-----------------:|---------------------:|-----------------------------------------:|------------:|-----------:|
| 12201 | Январь | 2 | 4 | 7 | 4 | 48000 |
| 12202 | Январь | 3 | 5 | 7 | 4 | 48000 |
| 12203 | Январь | 3 | 5 | 7 | 6 | 72000 |
| 12204 | Февраль | 3 | 3 | 4 | 2 | 37000 |
| 12205 | Февраль | 4 | 2 | 1 | 40 | 360000 |
| 12206 | Февраль | 4 | 1 | 1 | 40 | 360000 |
| 12207 | Март | 3 | 1 | 1 | 20 | 180000 |
| 12208 | Апрель | 2 | 4 | 3 | 10 | 70000 |
| 12209 | Апрель | 3 | 3 | 6 | 4 | 24000 |
| 12210 | Май | 1 | 2 | 6 | 2 | 12000 |
| 12211 | Май | 3 | 6 | 3 | 2 | 14000 |
| 12212 | Июнь | 5 | 4 | 7 | 10 | 120000 |
| 12213 | Июль | 3 | 4 | 4 | 10 | 185000 |
| 12214 | Июль | 5 | 4 | 2 | 6 | 60000 |
| 12215 | Август | 2 | 6 | 5 | 4 | 88000 |
| 12216 | Сентябрь | 1 | 4 | 5 | 6 | 132000 |
| 12217 | Сентябрь | 3 | 1 | 7 | 40 | 360000 |
| 88888 | Декабрь | 1 | 5 | 7 | 4 | 48000 |

## Задание 3
Реализовать триггер такой, что при вводе строки в таблице заказов, если сумма не указана, то она вычисляется 

``` 
CREATE OR REPLACE FUNCTION autoFillCost()
RETURNS TRIGGER
AS
$$
DECLARE price int;
BEGIN
	SELECT ПРЕЙСКУРАНТ.ЦЕНА INTO price FROM ПРЕЙСКУРАНТ
	WHERE ПРЕЙСКУРАНТ.ИДЕНТИФИКАТОР = NEW."ТОВАР ПО ПРЕЙСКУРАНТУ";
	
	IF NEW.ИТОГО is NULL THEN
		UPDATE ЗАКАЗ SET ИТОГО = price * NEW."КОЛ-ВО"
		WHERE "НОМЕР ВЕДОМОСТИ" = NEW."НОМЕР ВЕДОМОСТИ";
	END IF;
	RETURN NEW;
END
$$
LANGUAGE PLPGSQL;

CREATE OR REPLACE TRIGGER triggerAutoFillCost
AFTER INSERT ON ЗАКАЗ
FOR EACH ROW EXECUTE FUNCTION autoFillCost();
```

ДОБАВЛЕНИЕ СТРОКИ БЕЗ ИТОГОВОГО РАСЧЁТА

``` 
INSERT INTO "ЗАКАЗ" VALUES
(99999, 'Январь', 1, 5, 4, 10);
```
ДОБАВЛЕНИЕ СТРОКИ С ЗАРАНЕЕ ПРОСЧИТАННЫМ ИТОГОМ

```
INSERT INTO "ЗАКАЗ" VALUES
(00000, 'Январь', 1, 5, 4, 10, 185000);
```

```
SELECT * FROM ЗАКАЗ
```

| НОМЕР ВЕДОМОСТИ | ДАТА | ВОДИТЕЛЬ | ЦЕНТР ОБСЛ. | ТОВАР ПО ПРЕЙСКУРАНТУ | КОЛ-ВО | ИТОГО |
|------------------------------:|:---------|-----------------:|---------------------:|-----------------------------------------:|------------:|-----------:|
| 12201 | Январь | 2 | 4 | 7 | 4 | 48000 |
| 12202 | Январь | 3 | 5 | 7 | 4 | 48000 |
| 12203 | Январь | 3 | 5 | 7 | 6 | 72000 |
| 12204 | Февраль | 3 | 3 | 4 | 2 | 37000 |
| 12205 | Февраль | 4 | 2 | 1 | 40 | 360000 |
| 12206 | Февраль | 4 | 1 | 1 | 40 | 360000 |
| 12207 | Март | 3 | 1 | 1 | 20 | 180000 |
| 12208 | Апрель | 2 | 4 | 3 | 10 | 70000 |
| 12209 | Апрель | 3 | 3 | 6 | 4 | 24000 |
| 12210 | Май | 1 | 2 | 6 | 2 | 12000 |
| 12211 | Май | 3 | 6 | 3 | 2 | 14000 |
| 12212 | Июнь | 5 | 4 | 7 | 10 | 120000 |
| 12213 | Июль | 3 | 4 | 4 | 10 | 185000 |
| 12214 | Июль | 5 | 4 | 2 | 6 | 60000 |
| 12215 | Август | 2 | 6 | 5 | 4 | 88000 |
| 12216 | Сентябрь | 1 | 4 | 5 | 6 | 132000 |
| 12217 | Сентябрь | 3 | 1 | 7 | 40 | 360000 |
| 88888 | Декабрь | 1 | 5 | 7 | 4 | 48000 |
| 99999 | Январь | 1 | 5 | 4 | 10 | 185000 |
| 0 | Январь | 1 | 5 | 4 | 10 | 185000 |


## Задание 4
Создать представление (view), содержащее поля: фамилия водителя, дата, льгота, место работы, количество, стоимость заказа. Обеспечить возможность изменения предоставленной льготы. При этом должна быть пересчитана стоимость.

``` 
CREATE OR REPLACE VIEW customizableDriverView ("ФАМИЛИЯ ВОДИТЕЛЯ", ДАТА, ЛЬГОТА, "МЕСТО РАБОТЫ", КОЛИЧЕСТВО, "СТОИМОСТЬ ЗАКАЗА") 
AS (SELECT ВОДИТЕЛЬ.ФАМИЛИЯ, ЗАКАЗ.ДАТА, ВОДИТЕЛЬ.ЛЬГОТА, ВОДИТЕЛЬ.АВТОПРЕДПРИЯТИЕ,
    ЗАКАЗ."КОЛ-ВО", ЗАКАЗ.ИТОГО * (100 - ВОДИТЕЛЬ.ЛЬГОТА)/100
    FROM ВОДИТЕЛЬ
    JOIN ЗАКАЗ ON ВОДИТЕЛЬ.ИДЕНТИФИКАТОР = ЗАКАЗ.ВОДИТЕЛЬ);

CREATE OR REPLACE RULE customization AS
ON UPDATE TO customizableDriverView
DO INSTEAD
UPDATE ВОДИТЕЛЬ SET ЛЬГОТА = NEW.ЛЬГОТА WHERE ФАМИЛИЯ  = NEW."ФАМИЛИЯ ВОДИТЕЛЯ";

SELECT * FROM customizableDriverView
```

ПОЛУЧЕННОЕ ПРЕДСТАВЛЕНИЕ

| ФАМИЛИЯ ВОДИТЕЛЯ | ДАТА | ЛЬГОТА | МЕСТО РАБОТЫ | КОЛИЧЕСТВО | СТОИМОСТЬ ЗАКАЗА |
|:--------------------------------|:---------|-------------:|:------------------------|---------------------:|--------------------------------:|
| Попов | Январь | 0 | МП "ФорТУНА" | 4 | 48000 |
| Денисов | Январь | 10 | АО "Автотранс" | 4 | 43200 |
| Денисов | Январь | 10 | АО "Автотранс" | 6 | 64800 |
| Денисов | Февраль | 10 | АО "Автотранс" | 2 | 33300 |
| Сергеев | Февраль | 10 | АО "Автотранс" | 40 | 324000 |
| Сергеев | Февраль | 10 | АО "Автотранс" | 40 | 324000 |
| Денисов | Март | 10 | АО "Автотранс" | 20 | 162000 |
| Попов | Апрель | 0 | МП "ФорТУНА" | 10 | 70000 |
| Денисов | Апрель | 10 | АО "Автотранс" | 4 | 21600 |
| Горбунов | Май | 5 | АТП1 | 2 | 11400 |
| Денисов | Май | 10 | АО "Автотранс" | 2 | 12600 |
| Левкин | Июнь | 5 | АТП1 | 10 | 114000 |
| Денисов | Июль | 10 | АО "Автотранс" | 10 | 166500 |
| Левкин | Июль | 5 | АТП1 | 6 | 57000 |
| Попов | Август | 0 | МП "ФорТУНА" | 4 | 88000 |
| Горбунов | Сентябрь | 5 | АТП1 | 6 | 125400 |
| Денисов | Сентябрь | 10 | АО "Автотранс" | 40 | 324000 |
| Горбунов | Декабрь | 5 | АТП1 | 4 | 45600 |
| Горбунов | Январь | 5 | АТП1 | 10 | 175750 |
| Горбунов | Январь | 5 | АТП1 | 10 | 175750 |

ОБРАБОТКА ИЗМЕНЕНИЯ ЛЬГОТЫ ДЛЯ ВОДИТЕЛЯ С ФАМИЛИЕЙ ПОПОВ

``` 
UPDATE customizableDriverView SET ЛЬГОТА = 100 where customizableDriverView."ФАМИЛИЯ ВОДИТЕЛЯ" = 'Попов';
select * from customizableDriverView;
```

| ФАМИЛИЯ ВОДИТЕЛЯ | ДАТА | ЛЬГОТА | МЕСТО РАБОТЫ | КОЛИЧЕСТВО | СТОИМОСТЬ ЗАКАЗА |
|:--------------------------------|:---------|-------------:|:------------------------|---------------------:|--------------------------------:|
| Попов | Январь | 100 | МП "ФорТУНА" | 4 | 0 |
| Денисов | Январь | 10 | АО "Автотранс" | 4 | 43200 |
| Денисов | Январь | 10 | АО "Автотранс" | 6 | 64800 |
| Денисов | Февраль | 10 | АО "Автотранс" | 2 | 33300 |
| Сергеев | Февраль | 10 | АО "Автотранс" | 40 | 324000 |
| Сергеев | Февраль | 10 | АО "Автотранс" | 40 | 324000 |
| Денисов | Март | 10 | АО "Автотранс" | 20 | 162000 |
| Попов | Апрель | 100 | МП "ФорТУНА" | 10 | 0 |
| Денисов | Апрель | 10 | АО "Автотранс" | 4 | 21600 |
| Горбунов | Май | 5 | АТП1 | 2 | 11400 |
| Денисов | Май | 10 | АО "Автотранс" | 2 | 12600 |
| Левкин | Июнь | 5 | АТП1 | 10 | 114000 |
| Денисов | Июль | 10 | АО "Автотранс" | 10 | 166500 |
| Левкин | Июль | 5 | АТП1 | 6 | 57000 |
| Попов | Август | 100 | МП "ФорТУНА" | 4 | 0 |
| Горбунов | Сентябрь | 5 | АТП1 | 6 | 125400 |
| Денисов | Сентябрь | 10 | АО "Автотранс" | 40 | 324000 |
| Горбунов | Декабрь | 5 | АТП1 | 4 | 45600 |
| Горбунов | Январь | 5 | АТП1 | 10 | 175750 |
| Горбунов | Январь | 5 | АТП1 | 10 | 175750 |
